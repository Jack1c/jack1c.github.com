---
layout: post
title: 平均负载
toc: true
cover: /img/cover/9ee6c1c5d88b0468af1a3280865a6b7a.png
tags: ['linux']
category: Linux
---
# 平均负载

执行命令 `uptime ` 返回的结果就是系统 一分钟, 五分钟, 十五分钟的平均负载(load averages).  

```
uptime 
00:56:19 up  1:24,  2 users,  load average: 0.00, 0.00, 0.00
```



## 什么是平均负载

平均负载的定义:  在单位时间内, 系统处于**可运行状态**和**不可中断状态**的平均进程数, 也就是**平均活跃进程数** 

+ 可运行状态 : 真正使用CPU或者正在等待CPU的进程的进程. ps 命令看到的处于R(Runing或Runnable)状态的进程. 

+ 不可终端状态: 指进程正处于内核关键流程中的进程, 并且这些流程是不可打断的. 比如 等待设备IO相应, 对应于PS命令结果中的D状态(Uninterruptiable Sleep Disk Sleep)的进程

平均负载可以理解为平均活跃经常数. (实际是获取进程数的指数衰减平均值)

## 平均负载的分析

平均负载为平均活跃进程数, 系统最理想的状态为每个CPU上都刚好运行一个进程. 此时 CPU都得到充分利用. 

查看CPU个数命令:

```
cat /proc/cpuinfo | grep 'model name'| wc -l 
```

`uptime`命令返回了三个时间的平均负载, 能看出系统中平均负载的趋势. 

## 平均负载与CPU的使用率

平均负载不经包含**正在使用CPU的进程**, 还包括 **等待CPU和等待I/O**的进程

平均负载升高的原因:

+ CPU密集型进程. 使用大量的CPU使用平均负载升高. 
+ I/O密集型应用. 等待I/O导致平均负载升高 
+ 大量等待CPU的进程调度会导致平均负载升高

## 平均负载案例

### CPU密集型进程

1. 使用`stress` 命令模拟CPU使用率100% 

    ```
    stress --cpu 1 --timeout 600
    ```

2. 使用`uptime `查看平均负载的变化情况

    ```
    watch -d uptime 
    00:05:17 up 2 days, 33 min,  4 users,  load average: 7.30, 2.97, 2.20
    ```

3. 使用`mpstat`查看CPU使用率变化情况

    ```
    mpstat -P ALL 5
    Linux 4.15.0-47-generic  	2019年04月06日 	_x86_64_	(12 CPU)
    00时06分14秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
    00时06分19秒  all   83.31    0.00    0.00    0.00    0.00    0.08    0.00    0.00    0.00   16.60
    00时06分19秒    0    0.59    0.00    0.00    0.00    0.00    0.99    0.00    0.00    0.00   98.42
    00时06分19秒    1  100.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00
    00时06分19秒    2  100.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00
    
    ```

    从结果中可以开出 CPU使用率为100% 而 iowait只有0 . 说明平均负载的升高是由于CPU使用升高导致的. 

4. 使用 `pidstat`查看是哪个进程导致CPU使用率为100 

    ```
    # 间隔 5 秒后输出一组数据
    ipdstat -u 5 1 
    (base) root@jack-pc:~# pidstat -u 5 1
    Linux 4.15.0-47-generic (jack-pc) 	2019年04月06日 	_x86_64_	(12 CPU)
    
    00时11分32秒   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
    00时11分37秒  1000      1455    0.00    0.40    0.00    0.00    0.40     5  gnome-shell
    00时11分37秒     0     19374    0.20    0.00    0.00    0.00    0.20     3  kworker/3:5
    00时11分37秒     0     21640  100.00    0.00    0.00    0.00  100.00     0  stress
    00时11分37秒     0     21641  100.00    0.00    0.00    0.20  100.00    11  stress
    00时11分37秒     0     21642  100.00    0.00    0.00    0.00  100.00     9  stress
    00时11分37秒     0     21643  100.00    0.00    0.00    0.00  100.00     4  stress
    00时11分37秒     0     21644  100.00    0.00    0.00    0.20  100.00     3  stress
    ```

    从结果中可以看出是stress进程CPU使用率为100%



### I/O密集型进程

1. 使用 stress 命令模拟I/O 压力. (不停的执行sync)

    ```
    stress -i 1 --timeout 600
    ```

2. 使用`watch -d uptime`查看平均负载情况 

    ```
     00:16:44 up 2 days, 44 min,  4 users,  load average: 0.73, 4.61, 4.43
    ```

3. 使用 `mpstat` 查看CPU使用率变化情况

    ```
    # 显示所有 CPU 的指标，并在间隔 5 秒输出一组数据
    mpstat -P ALL 5 1
    Linux 4.17.5-1.el7.elrepo.x86_64 (izhp3cgtz8vqmpabdl2ux9z) 	2019年04月06日 	_x86_64_	(1 CPU)
    
    00时22分00秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
    00时22分05秒  all    1.47    0.00   30.74   67.79    0.00    0.00    0.00    0.00    0.00    0.00
    00时22分05秒    0    1.47    0.00   30.74   67.79    0.00    0.00    0.00    0.00    0.00    0.00
    ```

    从结果中可以看出是平均负载的升高是由于iowait的升高导致的. 

4. 使用pidstat定位iowait高的进程

    ```
    pidstat -u 5 1 
    平均时间:   UID       PID    %usr %system  %guest    %CPU   CPU  Command
    平均时间:     0       292    0.00    9.68    0.00    9.68     -  kworker/0:1H
    平均时间:     0      1104    0.65   23.01    0.00   23.66     -  stress
    平均时间:     0      1350    0.22    0.00    0.00    0.22     -  AliYunDun
    平均时间:     0      2150    0.22    0.00    0.00    0.22     -  java
    平均时间:   997     10350    0.00    0.22    0.00    0.22     -  redis-server
    平均时间:     0     24215    0.00    0.22    0.00    0.22     -  kworker/u2:1
    ```

### 大量进程

1. 使用stress模拟8个进程

    ```
    stress -c 8 --timeout 
    ```

2. 使用 stress查看平均负载 

    ```
    very 2.0s: uptime                                                                                   Sat Apr  6 00:29:44 2019
    
     00:29:44 up 192 days, 14:00,  3 users,  load average: 5.02, 2.26, 1.88
    
    ```

    平均负载明细升高 .

3. 使用pidstat查看进程的情况

    ```
    pidstat -u 5 1
    Linux 4.15.0-47-generic (jack-pc) 	2019年04月06日 	_x86_64_	(12 CPU)
    
    00时35分24秒   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
    00时35分29秒     0       968    0.20    0.00    0.00    0.00    0.20     2  accounts-daemon
    00时35分29秒  1000      1455    0.40    0.00    0.00    0.00    0.40     2  gnome-shell
    00时35分29秒     0      5570    0.00    0.20    0.00    0.00    0.20    10  kworker/10:2
    00时35分29秒     0     18806    0.00    0.20    0.00    0.00    0.20     4  kworker/4:1
    00时35分29秒     0     23573   21.76    0.00    0.00   78.24   21.76     9  stress
    00时35分29秒     0     23574   29.54    0.00    0.00   70.46   29.54     2  stress
    00时35分29秒     0     23575   23.95    0.00    0.00   76.05   23.95     7  stress
    00时35分29秒     0     23576   21.96    0.00    0.00   77.64   21.96    10  stress
    00时35分29秒     0     23577   22.16    0.00    0.00   78.04   22.16    11  stress
    00时35分29秒     0     23578   25.55    0.00    0.00   74.85   25.55     0  stress
    00时35分29秒     0     23579   22.16    0.00    0.00   77.84   22.16     9  stress
    00时35分29秒     0     23580   22.75    0.00    0.00   77.45   22.75    11  stress
    00时35分29秒     0     23581   23.35    0.00    0.00   77.05   23.35     1  stress
    00时35分29秒     0     23582   27.74    0.00    0.00   72.26   27.74     3  stress
    00时35分29秒     0     23583   23.75    0.00    0.00   76.45   23.75     7  stress
    00时35分29秒     0     23584   22.36    0.00    0.00   77.45   22.36     8  stress
    00时35分29秒     0     23585   27.15    0.00    0.00   73.05   27.15     7  stress
    00时35分29秒     0     23586   22.36    0.00    0.00   77.45   22.36     8  stress
    00时35分29秒     0     23587   22.16    0.00    0.00   78.04   22.16     8  stress
    00时35分29秒     0     23588   24.35    0.00    0.00   75.45   24.35     1  stress
    00时35分29秒     0     23589   22.55    0.00    0.00   77.64   22.55    10  stress
    00时35分29秒     0     23590   22.16    0.00    0.00   78.04   22.16     9  stress
    00时35分29秒     0     23591   22.16    0.00    0.00   77.64   22.16    10  stress
    00时35分29秒     0     23592   24.75    0.00    0.00   75.45   24.75     1  stress
    00时35分29秒     0     23593   21.36    0.00    0.00   78.64   21.36     9  stress
    ```

    可以看出是由于进程等待CPU导致平均负载升高